---
// src/layouts/Layout.astro
import '../styles/global.css';
import SEO from '../components/SEO.astro';
import Schema from '../components/Schema.astro';
import BackToTop from '../components/BackToTop.astro';
import { ClientRouter } from 'astro:transitions'; 
import GlobalSpotlight from '../components/GlobalSpotlight.astro';
import HapticFeedback from '../components/HapticFeedback.astro';

interface Props {
    title: string;
    description: string;
    image?: string;
}

const { title, description, image } = Astro.props;

// EU SPECIFIC ID
const GA_MEASUREMENT_ID = 'G-19T8LJEWVT';
---

<!doctype html>
<html lang="hu">
    <head>
        <SEO title={title} description={description} image={image} />
        <Schema title={title} description={description} url={Astro.url} image={image || '/images/og-image.jpg'} />
        <ClientRouter />
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" media="print" onload="this.media='all'">
        <noscript>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap">
        </noscript>
    
        <script define:vars={{ GA_MEASUREMENT_ID }}>
            // 1. Load Google Analytics
            function initAnalytics() {
                if (window.gtag) return;

                const script = document.createElement('script');
                script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
                script.async = true;
                
                script.onerror = function() {
                    console.error("CSP ERROR: Browser blocked GA4 script. Check netlify.toml!");
                };

                document.head.appendChild(script);

                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                window.gtag = gtag; 

                gtag('js', new Date());
                gtag('config', GA_MEASUREMENT_ID);
                console.log('âœ… Google Analytics (EU) started.');
            }

            // 2. Handle Consent
            function handleConsent() {
                 const consentData = localStorage.getItem('cookie_consent');
                if (consentData) {
                    const consent = JSON.parse(consentData);
                    if (consent.analytics) {
                        initAnalytics();
                    } else {
                        console.log('Analytics disabled by user.');
                    }
                }
            }

            // 3. Handle Page Views (Astro View Transitions)
            document.addEventListener('astro:page-load', () => {
                if (window.gtag) {
                    window.gtag('config', GA_MEASUREMENT_ID, {
                        page_path: window.location.pathname,
                        page_title: document.title
                    });
                }
            });

            // 4. Event Listeners
            document.addEventListener('DOMContentLoaded', handleConsent);
            document.addEventListener('astro:page-load', handleConsent);
            window.addEventListener('cookie-consent-updated', handleConsent);
        </script>
    </head>
    <body class="bg-gray-900 text-gray-200 font-sans leading-relaxed selection:bg-sky-500 selection:text-white">
        <slot />
        
        <BackToTop />
        <HapticFeedback />

        <script>
            import Lenis from 'lenis'

            let lenis;

            const initLenis = () => {
                if (lenis) return; // Prevent duplicates

                lenis = new Lenis({
                    duration: 1.2, 
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), 
                    smoothWheel: true,
                    wheelMultiplier: 1, 
                })

                function raf(time) {
                    lenis.raf(time)
                    requestAnimationFrame(raf)
                }

                requestAnimationFrame(raf)
                window.lenis = lenis; // Expose globally if needed
            }

            initLenis();

            // Handle anchor links with Lenis (optional but recommended)
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    lenis.scrollTo(this.getAttribute('href'));
                });
            });
        </script>

        <script>
            function setupAnimations() {
                const observerOptions = {
                    root: null,
                    threshold: 0.1
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            // Support both class naming conventions
                            if (entry.target.classList.contains('animate-on-scroll')) {
                                entry.target.classList.add("is-visible");
                            }
                            if (entry.target.classList.contains('reveal')) {
                                entry.target.classList.add('active');
                            }
                            observer.unobserve(entry.target);
                        }
                    });
                }, observerOptions);

                const elements = document.querySelectorAll(".animate-on-scroll, .reveal");
                elements.forEach((el) => observer.observe(el));
            }

            setupAnimations();
            document.addEventListener("astro:page-load", setupAnimations);
        </script>
    </body>
</html>

<style is:global>
    /* LENIS CSS */
    html.lenis, html.lenis body { height: auto; }
    .lenis.lenis-smooth { scroll-behavior: auto !important; }
    .lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
    .lenis.lenis-stopped { overflow: hidden; }
    .lenis.lenis-scrolling iframe { pointer-events: none; }

    /* EXISTING CSS */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #0B1120;
        background-image: 
            radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
        background-size: 2rem 2rem;
    }
    .animate-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        will-change: opacity, transform;
    }
    .animate-on-scroll.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
    .animate-on-scroll:nth-child(2) { transition-delay: 0.1s; }
    .animate-on-scroll:nth-child(3) { transition-delay: 0.2s; }
    .animate-on-scroll:nth-child(4) { transition-delay: 0.3s; }
</style>