---
// src/layouts/Layout.astro
import '../styles/global.css';
import SEO from '../components/SEO.astro';
import Schema from '../components/Schema.astro';
import BackToTop from '../components/BackToTop.astro';
import { ClientRouter } from 'astro:transitions'; 
import GlobalSpotlight from '../components/GlobalSpotlight.astro';
import HapticFeedback from '../components/HapticFeedback.astro';
import LogoPreloader from '../components/LogoPreloader.astro';
import PageTransition from '../components/PageTransition.astro';
import NoiseOverlay from '../components/NoiseOverlay.astro';
import CookieBanner from '../components/CookieBanner.astro';

interface Props {
    title: string;
    description: string;
    image?: string;
}

const { title, description, image } = Astro.props;

const GA_MEASUREMENT_ID = 'G-19T8LJEWVT';
---

<!doctype html>
<html lang="en">
    <head>
        <SEO title={title} description={description} image={image} />
        <Schema title={title} description={description} url={Astro.url} image={image || '/images/og-image.jpg'} />
        <ClientRouter />
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" media="print" onload="this.media='all'">
        <noscript>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap">
        </noscript>
    
        <script define:vars={{ GA_MEASUREMENT_ID }}>
            // 1. Load Google Analytics (Call only)
            function initAnalytics() {
                // If already loaded, do nothing
                if (window.gtag) return;

                const script = document.createElement('script');
                script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
                script.async = true;
                
                script.onerror = function() {
                    console.error("CSP Error: Google Analytics script blocked by browser!");
                };

                document.head.appendChild(script);

                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                window.gtag = gtag; 

                gtag('js', new Date());
                gtag('config', GA_MEASUREMENT_ID);
                console.log('âœ… Google Analytics started.');
            }

            // 2. Handle Consent
            function handleConsent() {
                 const consentData = localStorage.getItem('cookie_consent');
                if (consentData) {
                    const consent = JSON.parse(consentData);
                    if (consent.analytics) {
                        initAnalytics();
                    } else {
                        console.log('Analytics disabled by user.');
                    }
                }
            }

            // 3. Handle Page Views (Astro View Transitions)
            document.addEventListener('astro:page-load', () => {
                if (window.gtag) {
                    window.gtag('config', GA_MEASUREMENT_ID, {
                        page_path: window.location.pathname,
                        page_title: document.title
                    });
                }
            });

            // 4. Event Listeners
            // Run immediately on load
            document.addEventListener('DOMContentLoaded', handleConsent);
            // On page transition
            document.addEventListener('astro:page-load', handleConsent);
            // On consent update
            window.addEventListener('cookie-consent-updated', handleConsent);
        </script>
    </head>
    <body class="bg-gray-900 text-gray-200 font-sans leading-relaxed selection:bg-sky-500 selection:text-white">
        <LogoPreloader />
        <PageTransition />
        <slot />
        
        <BackToTop />
        <HapticFeedback />

                <CookieBanner />
<NoiseOverlay />

        <script>
            import Lenis from 'lenis'

            // Singleton pattern: create only once
            let lenis;

            const initLenis = () => {
                // If exists, don't create new (Important for View Transitions)
                if (lenis) return;

                lenis = new Lenis({
                    duration: 1.2, // Slightly slower, "premium" feel
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Classic "mobile-like" scroll math
                    smoothWheel: true,
                    wheelMultiplier: 1, // Scroll speed
                })

                function raf(time) {
                    lenis.raf(time)
                    requestAnimationFrame(raf)
                }

                requestAnimationFrame(raf)
                
                // Make global if needed for GSAP (e.g., ScrollTrigger)
                window.lenis = lenis;
            }

            // Start
            initLenis();

            // ClientRouter support: No need to restart Lenis on page change,
            // script ran, but if specific reset needed, add here.
            document.addEventListener('astro:page-load', () => {
                // Ensure scroll position is correct, though Router handles it
            });
        </script>
        
        <script>
            // Animation logic - Consolidated setup functions for cleaner code
            function setupAnimations() {
                const observerOptions = {
                    root: null,
                    threshold: 0.1
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            // Support both class names: 'animate-on-scroll' and 'reveal'
                            if (entry.target.classList.contains('animate-on-scroll')) {
                                entry.target.classList.add("is-visible");
                            }
                            if (entry.target.classList.contains('reveal')) {
                                entry.target.classList.add('active');
                            }
                            observer.unobserve(entry.target);
                        }
                    });
                }, observerOptions);

                // Select both types of elements
                const elements = document.querySelectorAll(".animate-on-scroll, .reveal");
                elements.forEach((el) => observer.observe(el));
            }

            // Initialize
            setupAnimations();
            document.addEventListener("astro:page-load", setupAnimations);
        </script>


    </body>
</html>

<style is:global>
    /* --- LENIS REQUIRED CSS --- */
    html.lenis, html.lenis body {
        height: auto;
    }

    .lenis.lenis-smooth {
        scroll-behavior: auto !important; /* Overrides native smooth scroll */
    }

    .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
    }

    .lenis.lenis-stopped {
        overflow: hidden;
    }

    .lenis.lenis-scrolling iframe {
        pointer-events: none; /* Performance improvement during scroll */
    }

    /* --- YOUR EXISTING STYLES --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #0B1120;
        background-image: 
            radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
        background-size: 2rem 2rem;
    }
    
    .animate-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        will-change: opacity, transform; /* Performance optimization */
    }
    .animate-on-scroll.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
    .animate-on-scroll:nth-child(2) { transition-delay: 0.1s; }
    .animate-on-scroll:nth-child(3) { transition-delay: 0.2s; }
    .animate-on-scroll:nth-child(4) { transition-delay: 0.3s; }
</style>